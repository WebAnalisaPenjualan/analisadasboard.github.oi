<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ControlTrack</title>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <!-- Library XLSX dan Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Global Styles */
      * {
        box-sizing: border-box;
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
      }
      body {
        background: linear-gradient(135deg, #e0eafc, #cfdef3);
        color: #333;
        overflow-x: hidden;
      }
      header {
        background-color: #fff;
        padding: 2px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
      header h1 {
        margin: 0;
        font-size: 2.5em;
        font-weight: bold;
        color: #0726f0;
      }
      header p {
        margin: 1px 0;
        color: #0726f0;
        font-style: italic;
      }
      header .version {
        font-size: 0.6em;
        color: #8291ed;
      }
      /* Sidebar Styles */
      .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        width: 60px;
        background: #fff;
        border-right: 2px solid #e0e0e0;
        box-shadow: 2px 0 2px rgba(0, 0, 0, 0.1);
        transition: width 0.3s ease;
        z-index: 1000;
        overflow: visible;
      }
      .sidebar:hover {
        width: 200px;
      }
      .sidebar ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .sidebar li {
        position: relative;
      }
      .sidebar a {
        display: flex;
        align-items: center;
        text-decoration: none;
        padding: 8px;
        color: #4a90e2;
        font-size: 11px;
        transition: background 0.2s, color 0.2s;
      }
      .sidebar a:hover {
        background: #f0f0f0;
        color: #0056b3;
      }
      .sidebar a .menu-icon {
        width: 24px;
        height: 24px;
        margin-right: 8px;
        transition: transform 0.2s;
      }
      .sidebar a:hover .menu-icon {
        transform: scale(1.1);
      }
      .sidebar a span {
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .sidebar:hover a span {
        opacity: 1;
      }
      /* Kesamaping (submenu) & Submenu Income Statement */
      .kesamaping,
      .submenu {
        display: none;
        position: absolute;
        top: 0;
        left: 100%;
        background: #f9f9f9;
        min-width: 140px;
        z-index: 1000;
        box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.15);
      }
      .sidebar li:hover > .kesamaping,
      .sidebar li.has-submenu:hover > .submenu {
        display: block;
      }
      .kesamaping li a,
      .submenu li a {
        padding: 10px 15px;
        font-size: 10px;
        color: #4a90e2;
        white-space: nowrap;
      }
      .kesamaping li a:hover,
      .submenu li a:hover {
        background: #e8e8e8;
      }
      /* Container */
      .container {
        margin: 20px;
        margin-left: 80px;
        transition: margin-left 0.3s ease;
      }
      /* Upload Section */
      .upload-section {
        text-align: center;
        margin-bottom: 20px;
      }
      .motor-images {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
      }
      .motor-images img {
        width: 120px;
        border: 3px solid #4a90e2;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        transition: transform 0.3s;
      }
      .motor-images img:hover {
        transform: scale(1.05);
        cursor: pointer;
      }
      /* Buttons */
      .btn {
        padding: 10px 20px;
        background-color: #28a745;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-right: 10px;
      }
      .btn:hover {
        background-color: #218838;
      }
      .toggle-btn {
        background-color: #6c757d;
      }
      .toggle-btn:hover {
        background-color: #5a6268;
      }
      .top-buttons {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 20px;
      }
      /* Filter Container */
      .filter-container {	
        text-align: center;
        margin-bottom: 20px;
        transition: height 0.3s ease;
      }
      .filter-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;	
      }
      .filter-group label {
        margin-right: 10px;
      }
      /* Tambahan CSS untuk filter Sales Analysis secara horizontal dengan checkbox */
      #salesAnalysis-filter-container {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }
      /* Table Styles - Modern & Simetris */
      .table-container {
        overflow-x: auto;
        margin-bottom: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px auto;
        background: #fff;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-family: 'Roboto', sans-serif;
        font-size: 14px;
      }
      table th,
      table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
        vertical-align: middle;
        word-wrap: break-word;
      }
      table th {
        background-color: #4a90e2;
        color: #fff;
        font-weight: 500;
      }
      table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      table tbody tr:hover {
        background-color: #f1f1f1;
      }
      /* Dashboard Table Styles */
      #dashboard-sales-summary table,
      #dashboard-cash-credit-summary table {
        width: 100%;
        border-collapse: collapse;
      }
      #dashboard-sales-summary th,
      #dashboard-sales-summary td,
      #dashboard-cash-credit-summary th,
      #dashboard-cash-credit-summary td {
        border: 1px solid #ddd;
        padding: 8px;
      }
      #dashboard-sales-summary th,
      #dashboard-cash-credit-summary th {
        background-color: #4a90e2;
        color: #fff;
      }
      /* Tabel Simetris untuk Income Statement */
      .symmetric-table {
        width: 100%;
        table-layout: auto;
        border-collapse: collapse;
        margin: 20px auto;
        font-family: 'Roboto', sans-serif;
        font-size: 14px;
      }
      .symmetric-table th,
      .symmetric-table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
        min-width: 120px;
      }
      .symmetric-table th {
        background-color: #4a90e2;
        color: #fff;
        font-weight: 500;
      }
      .symmetric-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      .symmetric-table tbody tr:hover {
        background-color: #f1f1f1;
      }
      /* Chart Container */
      .chart-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto 20px;
      }
      @keyframes slideRight {
        from {
          transform: translateX(-100%);
        }
        to {
          transform: translateX(0);
        }
      }
      /* Aturan CSS untuk Sales Analysis Description */
      .sales-analysis-desc {
        margin-top: 10px;   /* Jarak atas */
        margin-bottom: 40px;/* Jarak bawah */
        font-size: 12px;    /* Ukuran font */
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <ul>
        <li>
          <a href="#dashboard" id="dashboardLink">
            <img src="dash.png" alt="Dashboard" class="menu-icon" />
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a href="#kpi" id="kpiLink">
            <img src="kpi.png" alt="KPI" class="menu-icon" />
            <span>KPI</span>
          </a>
        </li>
        <!-- Laporan Penjualan dengan kesamaping tambahan -->
        <li>
          <a href="#laporan" id="laporanPenjualanLink">
            <img src="icongraf.png" alt="Sales Report" class="menu-icon" />
            <span>Laporan Penjualan</span>
          </a>
          <ul class="kesamaping">
            <li>
              <a href="#salesAnalysis" id="salesAnalysisLink">
                <img src="salesanalisis.png" alt="Sales Analysis" class="menu-icon" style="width:20px; height:20px; margin-right:5px;" />
                <span>Sales Analysis</span>
              </a>
            </li>
            <li>
              <a href="#trenSales" id="trenSalesLink">
                <img src="trandsales.png" alt="Tren Sales" class="menu-icon" style="width:20px; height:20px; margin-right:5px;" />
                <span>Tren Sales</span>
              </a>
            </li>
            <li>
              <a href="#achievement" id="achievementLink">
                <img src="achitmen.png" alt="Achievement" class="menu-icon" style="width:20px; height:20px; margin-right:5px;" />
                <span>Achievement</span>
              </a>
            </li>
            <li>
              <a href="#inputTargetSales" id="inputTargetSalesLink">
                <img src="target.png" alt="Input Target Sales" class="menu-icon" style="width:20px; height:20px; margin-right:5px;" />
                <span>Input Target Sales</span>
              </a>
            </li>
          </ul>
        </li>
        <li>
          <a href="#audit">
            <img src="audit.png" alt="Audit Transaksi" class="menu-icon" />
            <span>Audit Transaksi</span>
          </a>
        </li>
        <li>
          <a href="#isauditcontrol" id="isauditcontrolLink">
            <img src="isc.png" alt="IS Audit Control" class="menu-icon" />
            <span>IS Audit Control</span>
          </a>
        </li>
        <!-- Trial Balance tetap sebagai item utama tanpa submenu -->
        <li>
          <a href="#trialbalance" id="trialbalanceLink">
            <img src="tb.png" alt="Trial Balance" class="menu-icon" />
            <span>Trial Balance</span>
          </a>
        </li>
        <!-- Pindahkan sub menu Report dan Analisa dari Trial Balance ke Income Statement -->
        <li class="has-submenu">
          <a href="#incomestatement" id="incomestatementLink">
            <img src="inst.png" alt="Income Statement" class="menu-icon" />
            <span>Income Statement</span>
          </a>
          <ul class="submenu">
            <li>
              <a href="#tbReport" id="tbReportLink">
                <img src="lapor.png" alt="Report" class="menu-icon" style="width:20px; height:20px; margin-right:5px;" />
                <span>Report</span>
              </a>
            </li>
            <li>
              <a href="#tbAnalisa" id="tbAnalisaLink">
                <img src="analisa.png" alt="Analisa" class="menu-icon" style="width:20px; height:20px; margin-right:5px;" />
                <span>Analisa</span>
              </a>
            </li>
          </ul>
        </li>
        <li>
          <a href="#statementcashflows" id="statementcashflowsLink">
            <img src="socf.png" alt="Cash Flows" class="menu-icon" />
            <span>Statement Of Cash Flows</span>
          </a>
        </li>
        <li>
          <a href="#potentialSalesClaimRevenue" id="potentialSalesClaimRevenueLink">
            <img src="vbd.png" alt="Potential Revenue" class="menu-icon" />
            <span>Potential Sales Claim Revenue</span>
          </a>
        </li>
        <li>
          <a href="#salesCashCredit" id="salesCashCreditLink">
            <img src="byr.png" alt="Sales Cash &amp; Credit" class="menu-icon" />
            <span>Sales Cash &amp; Credit</span>
          </a>
        </li>
        <li>
          <a href="#inventoryreconciliation" id="inventoryReconciliationLink">
            <img src="inven.png" alt="Inventory Reconciliation" class="menu-icon" />
            <span>Inventory Reconciliation</span>
          </a>
        </li>
        <li>
          <a href="#upload" id="uploadDataLink">
            <img src="uplod.png" alt="Upload Data" class="menu-icon" />
            <span>Upload Data</span>
          </a>
        </li>
        <!-- Item Upload File TB -->
        <li>
          <a href="#tbUpload" id="tbUploadLink">
            <img src="upload2.png" alt="Upload TB" class="menu-icon" style="width:20px; height:20px; margin-right:5px;" />
            <span>Upload File TB</span>
          </a>
        </li>
		<!-- Tambahkan item tombol kembali di sini -->
        <li>
  <button onclick="window.location.href='index.html'" 
        style="width:33%; padding:5px; border:none; background-color:#f0f0f0; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#4a90e2;font-family: 'Roboto', sans-serif; font-size:11px;">
  <img src="back2.png" alt="Back ControlTrack" class="menu-icon" style="width:20px; height:20px; margin-right:5px;" />
  <span> Back</span>
</button>

</li>

        </ul>
    </div>

    <!-- Hidden file input untuk Upload File TB -->
    <input type="file" id="uploadTB" accept=".xlsx, .xls" style="display: none;" />

    <!-- Header -->
    <header>
      <h1>-=--ControlTrack--=-</h1>
      <p>Tools Pemantauan dan Kontrol dalam Audit</p>
      <p class="version">ControlTrack V2.1 (Build 0225) - Developed by Agung</p>
    </header>

    <!-- Main Content -->

    <!-- Dashboard View -->
    <div class="container" id="dashboard-view" style="display: none;">
      <h2>Dashboard</h2>
      <div id="dashboard-sales-summary">
        <!-- Sales summary table -->
      </div>
      <div id="dashboard-cash-credit-summary">
        <!-- Cash & Credit summary table -->
      </div>
    </div>

    <!-- KPI View -->
    <div class="container" id="kpi-view" style="display: none;">
      <h2>Key Performance Indicators (KPI)</h2>
      <p>KPI Kepatuhan dan Pengendalian.</p>
    </div>

    <!-- Laporan Penjualan View -->
    <div class="container" id="laporan-view" style="display: none;">
      <h2>Laporan Penjualan</h2>
      <div class="upload-section">
        <h3>Audit In Control (SPI)</h3>
        <input type="file" id="upload" accept=".xlsx, .xls" />
        <div class="motor-images">
          <img src="Capture1.png" alt="Motor 1" />
          <img src="Capture2.png" alt="Motor 2" />
          <img src="Capture.png" alt="Motor 3" />
          <img src="sonic.png" alt="Motor 4" />
          <img src="adv.png" alt="Motor 5" />
          <img src="staylo2.png" alt="Motor 6" />
          <img src="cbr250.png" alt="Motor 7" />
        </div>
      </div>
      <div class="top-buttons">
        <button class="btn toggle-btn" id="toggleFilterBtn">Sembunyikan Filter</button>
      </div>
      <div id="filterSection" class="filter-container">
        <div class="filter-group">
          <strong>Pilih Tahun:</strong>
          <span id="yearFilterContainer"></span>
        </div>
        <div class="filter-group">
          <strong>Pilih Cabang:</strong>
          <span id="ptFilterContainer"></span>
        </div>
      </div>
      <div id="data-container">
        <div class="table-container">
          <table id="data-table">
            <thead>
              <tr>
                <th>Year</th>
                <th>Cabang</th>
                <th>1</th>
                <th>2</th>
                <th>3</th>
                <th>4</th>
                <th>5</th>
                <th>6</th>
                <th>7</th>
                <th>8</th>
                <th>9</th>
                <th>10</th>
                <th>11</th>
                <th>12</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
  <!-- Data Sheet1 -->
  <tr>
    <td colspan="15">
      <a href="index.html" class="back-link">Kembali ke Menu Utama</a>
    </td>
  </tr>
</tbody>
          </table>
        </div>
        <div class="chart-container">
          <canvas id="salesChart"></canvas>
        </div>
      </div>
      <div id="sheet2-container">
        <div class="table-container">
          <table id="sheet2-table">
            <thead>
              <tr>
                <th colspan="11" style="text-align: center; font-weight: bold;">
                  Cumulative Margin and Diskon
                </th>
              </tr>
              <tr>
                <th>Year</th>
                <th>Cabang</th>
                <th>Margin Unit</th>
                <th>Sisa Margin</th>
                <th>Gross Profit Setelah Sub</th>
                <th>Pot Dealer</th>
                <th>Pot Tambahan</th>
                <th>Pot Leasing</th>
                <th>Pot ATPM</th>
                <th>Pot MD</th>
                <th>Broker</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data Sheet2 -->
            </tbody>
          </table>
        </div>
        <div class="chart-container">
          <canvas id="sheet2Chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Sales Cash & Credit (Sheet3) View -->
    <div class="container" id="sheet3-view" style="display: none;">
      <h1>Sales Cash &amp; Credit</h1>
      <div class="filter-container">
        <div class="filter-group">
          <strong>Pilih Tahun:</strong>
          <span id="yearFilterSheet3"></span>
        </div>
        <div class="filter-group">
          <strong>Pilih Cabang:</strong>
          <span id="cabangFilterSheet3"></span>
        </div>
        <div class="filter-group">
          <strong>Pilih Pembayaran:</strong>
          <span id="pembayaranFilterSheet3"></span>
        </div>
      </div>
      <div class="table-container">
        <table id="sheet3-table">
          <thead>
            <tr>
              <th>Year</th>
              <th>Cabang</th>
              <th>Pembayaran</th>
              <th>01</th>
              <th>02</th>
              <th>03</th>
              <th>04</th>
              <th>05</th>
              <th>06</th>
              <th>07</th>
              <th>08</th>
              <th>09</th>
              <th>10</th>
              <th>11</th>
              <th>12</th>
              <th>Grand Total</th>
            </tr>
          </thead>
          <tbody id="sheet3TableBody">
            <!-- Data Sheet3 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Trial Balance View with Filter (Tahun, PT, GL ACC1, Bulan) -->
    <div class="container" id="trialbalance-view" style="display: none;">
      <h2>Trial Balance</h2>
      <!-- Filter Container untuk Trial Balance -->
      <div id="trialbalance-filter-container" class="filter-container" style="margin-bottom: 20px;">
        <div class="filter-group">
          <label><strong>Pilih Tahun:</strong></label>
          <select id="trialbalance-year-filter">
            <option value="">Semua</option>
          </select>
        </div>
        <div class="filter-group">
          <label><strong>Pilih PT:</strong></label>
          <select id="trialbalance-pt-filter">
            <option value="">Semua</option>
          </select>
        </div>
        <div class="filter-group">
          <label><strong>Pilih GL ACC1:</strong></label>
          <select id="trialbalance-gl-acc1-filter">
            <option value="">Semua</option>
          </select>
        </div>
        <div class="filter-group">
          <label><strong>Pilih Bulan:</strong></label>
          <select id="trialbalance-month-filter">
            <option value="">Semua</option>
          </select>
        </div>
        <button class="btn" id="trialbalance-apply-filter">Terapkan Filter</button>
      </div>
      <div class="table-container" id="trialbalance-data-container">
        <!-- Tabel data Ledger_Mutation akan dirender di sini -->
      </div>
    </div>

    <!-- Report View (Trial Balance Report) -->
    <div class="container" id="tbReport-view" style="display: none;">
      <h2>Trial Balance Report</h2>
      <!-- Dropdown filter PT -->
      <div id="ptReportSelectContainer"></div>
      <!-- Tabel report akan dirender oleh fungsi renderTrialBalanceReport() -->
      <div class="table-container" id="tbReportTableContainer">
        <!-- Tabel report akan muncul di sini -->
      </div>
    </div>

    <!-- Income Statement View -->
    <div class="container" id="incomestatement-view" style="display: none;">
      <h2>Income Statement</h2>
      <div class="upload-section">
        <h3>Upload Excel Data for Income Statement</h3>
        <input type="file" id="uploadIncomeStatement" accept=".xlsx, .xls" />
      </div>
      <div id="incomeStatementSheet1"></div>
      <p>Silakan tambahkan konten untuk Income Statement di sini.</p>
    </div>

    <!-- Statement Of Cash Flows View -->
    <div class="container" id="statementcashflows-view" style="display: none;">
      <h2>Statement Of Cash Flows</h2>
      <p>Silakan tambahkan konten untuk Statement Of Cash Flows di sini.</p>
    </div>

    <!-- Inventory Reconciliation View -->
    <div class="container" id="inventoryreconciliation-view" style="display: none;">
      <h2>Inventory Reconciliation</h2>
      <p>Silakan tambahkan konten untuk Inventory Reconciliation di sini.</p>
    </div>

    <!-- Potential Sales Claim Revenue (Sheet4) View -->
    <div class="container" id="potential-sales-claim-revenue-view" style="display: none;">
      <h2>Potential Sales Claim Revenue</h2>
      <div class="table-container">
        <table id="sheet4-table">
          <thead>
            <tr>
              <th>Year</th>
              <th>Cabang</th>
              <th>01</th>
              <th>02</th>
              <th>03</th>
              <th>04</th>
              <th>05</th>
              <th>06</th>
              <th>07</th>
              <th>08</th>
              <th>09</th>
              <th>10</th>
              <th>11</th>
              <th>12</th>
              <th>Grand Total</th>
            </tr>
          </thead>
          <tbody id="sheet4TableBody">
            <!-- Data Sheet4 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- IS Audit Control View -->
    <div class="container" id="isauditcontrol-view" style="display: none;">
      <h2>IS Audit Control</h2>
      <p>Silakan tambahkan konten untuk IS Audit Control di sini.</p>
    </div>

    <!-- Halaman Sub Menu -->
    <!-- Sales Analysis View -->
    <div class="container" id="salesAnalysis-view" style="display: none;">
      <h2>Sales Analysis</h2>
      <p class="sales-analysis-desc"></p>
      <!-- FILTER SALES ANALYSIS DENGAN CHECKBOX (DI SAMPING) -->
      <div id="salesAnalysis-filter-container" class="filter-container">
        <!-- Filter Tahun -->
        <div class="filter-group">
          <label><strong>Pilih Tahun:</strong></label>
          <!-- Checkboxes untuk tahun akan diisi secara dinamis -->
        </div>
        <!-- Filter Cabang (contoh, jika diperlukan) -->
        <div class="filter-group">
          <label><strong>Pilih Cabang:</strong></label>
          <!-- Checkboxes untuk cabang akan diisi secara dinamis -->
        </div>
        <button class="btn" id="salesAnalysisApplyFilter">Show</button>
      </div>
      <!-- Tabel Sales Analysis dengan Header baru -->
      <table>
        <thead>
          <tr>
            <th>Year</th>
            <th>Cabang</th>
            <th>Margin Unit</th>
            <th>Gross Profit Setelah Sub</th>
            <th>Total Potongan</th>
            <th>Persentase Potongan (%)</th>
            <th>Rasio Profitabilitas</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data nantinya akan diisi dari Sheet2 -->
        </tbody>
      </table>
      <!-- Tambahkan 2 grafik di bawah tabel Sales Analysis -->
      <div class="chart-container">
        <canvas id="profitabilityChart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="discountPercentageChart"></canvas>
      </div>
    </div>

    <!-- Tren Sales View -->
    <div class="container" id="trenSales-view" style="display: none;">
      <h2>Tren Sales</h2>
      <!-- Grafik Line: Tren Sales berdasarkan Margin Unit per Cabang (tanpa filter) -->
      <div class="chart-container">
        <canvas id="trenSalesChart"></canvas>
      </div>
      <!-- Filter khusus untuk grafik Bar diletakkan di atas grafik Bar -->
      <div id="trenSalesBarFilterContainer" class="filter-container" style="margin-bottom:20px;">
        <strong>Pilih Tahun:</strong>
        <!-- Checkbox tahun untuk grafik Bar akan diisi secara dinamis -->
      </div>
      <!-- Grafik Bar: X = Cabang, Y = Total Margin (menggunakan filter) -->
      <div class="chart-container">
        <canvas id="trenSalesBarChart"></canvas>
      </div>
    </div>

    <!-- Achievement View -->
    <div class="container" id="achievement-view" style="display: none;">
      <h2>Achievement</h2>
      <p>Content for Achievement page goes here.</p>
    </div>
    <!-- Input Target Sales View -->
    <div class="container" id="inputTargetSales-view" style="display: none;">
      <h2>Input Target Sales</h2>
      <p>Content for Input Target Sales page goes here.</p>
    </div>

    <script>
      // Variabel Global
      let jsonData = [];
      let sheet2Data = [];
      let sheet3Data = [];
      let sheet4Data = []; // Data untuk Potential Sales Claim Revenue
      let ledgerMutationData = []; // Data untuk file TB (Ledger_Mutation)
      let chartInstance; // Chart untuk Sheet1
      let sheet2ChartInstance; // Chart untuk Sheet2
      let salesAnalysisProfitabilityChart;
      let salesAnalysisDiscountChart;
      let trenSalesChartInstance;
      let trenSalesBarChartInstance;

      // Fungsi formatNumber: mengonversi nilai ke angka, membulatkan, lalu memformat dengan pemisah ribuan.
      function formatNumber(value) {
        const num = Number(value);
        if (isNaN(num)) return value;
        const rounded = Math.round(num);
        const formatted = Math.abs(rounded).toLocaleString('en-US');
        return rounded < 0 ? '(' + formatted + ')' : formatted;
      }
	  
  function formatNumberWithCommas(value) {
    if (!isNaN(value) && value !== "") {
      return Number(value).toLocaleString('en-US');
    }
    return value;
  }

  function renderTrialBalance() {
    const container = document.getElementById("trialbalance-data-container");
    if (!ledgerMutationData || ledgerMutationData.length === 0) {
      container.innerHTML = "<p>No data available.</p>";
      return;
    }
    
    const selectedYear = document.getElementById("trialbalance-year-filter").value;
    const selectedPT = document.getElementById("trialbalance-pt-filter").value;
    const selectedGLAcc1 = document.getElementById("trialbalance-gl-acc1-filter").value;
    const selectedMonth = document.getElementById("trialbalance-month-filter").value;
    
    const header = ledgerMutationData[0];
    let filteredRows = ledgerMutationData.slice(1).filter(row => {
      let match = true;
      if (selectedYear && row[0] !== selectedYear) match = false;
      if (selectedPT && row[1] !== selectedPT) match = false;
      if (selectedGLAcc1 && row[2] !== selectedGLAcc1) match = false;
      if (selectedMonth && row[3] !== selectedMonth) match = false;
      return match;
    });
    
    let html = "<table id='trialbalance-table'><thead><tr>";
    header.forEach(cell => html += `<th>${cell}</th>`);
    html += "</tr></thead><tbody>";
    
    filteredRows.forEach(row => {
      html += "<tr>";
      row.forEach(cell => {
        let formattedCell = formatNumberWithCommas(cell);
        html += `<td>${formattedCell}</td>`;
      });
      html += "</tr>";
    });
    html += "</tbody></table>";
    container.innerHTML = html;
  }
  
      // Fungsi renderDashboardSalesSummary (tetap sama)
      function renderDashboardSalesSummary() {
        const dashboardDiv = document.getElementById("dashboard-sales-summary");
        if (!jsonData || jsonData.length < 3) {
          dashboardDiv.innerHTML = "<p>No data available.</p>";
          return;
        }
        let penjualanRows = jsonData.slice(2);
        const selectedYears = Array.from(document.querySelectorAll('#yearFilterContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        if (selectedYears.length > 0) {
          penjualanRows = penjualanRows.filter(row => selectedYears.includes(String(row[0])));
        }
        const selectedCabangs = Array.from(document.querySelectorAll('#ptFilterContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        if (selectedCabangs.length > 0) {
          penjualanRows = penjualanRows.filter(row => selectedCabangs.includes(String(row[1])));
        }
        let penjualanGroup = {};
        penjualanRows.forEach(row => {
          const year = row[0] || "Unknown";
          const branch = row[1] || "Unknown";
          const totalPenjualan = parseFloat(row[14]) || 0;
          if (!penjualanGroup[year]) {
            penjualanGroup[year] = {};
          }
          if (!penjualanGroup[year][branch]) {
            penjualanGroup[year][branch] = 0;
          }
          penjualanGroup[year][branch] += totalPenjualan;
        });
        let discountGroup = {};
        if (sheet2Data && sheet2Data.length > 1) {
          let discountRows = sheet2Data.slice(1);
          if (selectedYears.length > 0) {
            discountRows = discountRows.filter(row => selectedYears.includes(String(row[0])));
          }
          if (selectedCabangs.length > 0) {
            discountRows = discountRows.filter(row => selectedCabangs.includes(String(row[1])));
          }
          discountRows.forEach(row => {
            const year = row[0] || "Unknown";
            const branch = row[1] || "Unknown";
            const discount = (parseFloat(row[5]) || 0) + (parseFloat(row[6]) || 0) + (parseFloat(row[10]) || 0);
            if (!discountGroup[year]) {
              discountGroup[year] = {};
            }
            if (!discountGroup[year][branch]) {
              discountGroup[year][branch] = 0;
            }
            discountGroup[year][branch] += discount;
          });
        }
        let marginUnitGroup = {};
        if (sheet2Data && sheet2Data.length > 1) {
          let marginUnitRows = sheet2Data.slice(1);
          if (selectedYears.length > 0) {
            marginUnitRows = marginUnitRows.filter(row => selectedYears.includes(String(row[0])));
          }
          if (selectedCabangs.length > 0) {
            marginUnitRows = marginUnitRows.filter(row => selectedCabangs.includes(String(row[1])));
          }
          marginUnitRows.forEach(row => {
            const year = row[0] || "Unknown";
            const branch = row[1] || "Unknown";
            const marginUnit = parseFloat(row[2]) || 0;
            if (!marginUnitGroup[year]) {
              marginUnitGroup[year] = {};
            }
            if (!marginUnitGroup[year][branch]) {
              marginUnitGroup[year][branch] = 0;
            }
            marginUnitGroup[year][branch] += marginUnit;
          });
        }
        let html = "<h3 style='font-style: italic; font-size: 0.8em; color: black; animation: slideRight 2s ease-out;'>Total Diskon (Pot Dealer + Pot Tambahan + Broker), Average Diskon (Diskon / Penjualan), dan Average Margin Unit (Margin Unit / Penjualan)</h3>";
        html += "<table>";
        html += "<thead><tr><th>Tahun</th><th>Cabang</th><th>Total Penjualan</th><th>Total Diskon</th><th>Average Diskon</th><th>Average Margin Unit</th></tr></thead><tbody>";
        for (const year in penjualanGroup) {
          for (const branch in penjualanGroup[year]) {
            const penjualan = penjualanGroup[year][branch];
            const diskon = (discountGroup[year] && discountGroup[year][branch]) ? discountGroup[year][branch] : 0;
            let avgDiskon = "-";
            if (penjualan !== 0) {
              avgDiskon = diskon / penjualan;
            }
            const totalMarginUnit = (marginUnitGroup[year] && marginUnitGroup[year][branch]) ? marginUnitGroup[year][branch] : 0;
            let avgMarginUnit = "-";
            if (penjualan !== 0) {
              avgMarginUnit = totalMarginUnit / penjualan;
            }
            html += `<tr>
                       <td>${year}</td>
                       <td>${branch}</td>
                       <td><span class="dashboard-value">${formatNumber(penjualan)}</span></td>
                       <td><span class="dashboard-value">${formatNumber(diskon)}</span></td>
                       <td>${avgDiskon !== "-" ? '<span class="dashboard-value">' + formatNumber(avgDiskon) + '</span>' : '-'}</td>
                       <td>${avgMarginUnit !== "-" ? '<span class="dashboard-value">' + formatNumber(avgMarginUnit) + '</span>' : '-'}</td>
                     </tr>`;
          }
        }
        html += "</tbody></table>";
        dashboardDiv.innerHTML = html;
      }

      function renderDashboardCashCreditSummary() {
        const summaryDiv = document.getElementById("dashboard-cash-credit-summary");
        if (!sheet3Data || sheet3Data.length < 2) {
          summaryDiv.innerHTML = "<p>No Sales Cash & Credit data available.</p>";
          return;
        }
        const selectedYears = Array.from(document.querySelectorAll('#yearFilterContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedCabangs = Array.from(document.querySelectorAll('#ptFilterContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        let rows = sheet3Data.slice(1);
        if (selectedYears.length > 0) {
          rows = rows.filter(row => selectedYears.includes(String(row[0])));
        }
        if (selectedCabangs.length > 0) {
          rows = rows.filter(row => selectedCabangs.includes(String(row[1])));
        }
        const creditTypes = ["ADIRA", "FIF", "MF", "SOF", "WOM", "BPR AM", "MCF", "MCF2", "IMFI", "MUF", "MMF", "MPMF"];
        const group = {};
        rows.forEach(row => {
          const year = row[0] || "Unknown";
          const cabang = row[1] || "Unknown";
          const pembayaran = (row[2] || "").toString().toUpperCase();
          const grandTotal = parseFloat(row[15]) || 0;
          if (!group[year]) {
            group[year] = {};
          }
          if (!group[year][cabang]) {
            group[year][cabang] = { cash: 0, credit: 0 };
          }
          if (pembayaran === "CASH") {
            group[year][cabang].cash += grandTotal;
          } else if (creditTypes.includes(pembayaran)) {
            group[year][cabang].credit += grandTotal;
          }
        });
        let html = "<h3 style='font-style: italic; font-size: 0.8em; color: black; animation: slideRight 2s ease-out;'>Summary Sales Cash & Credit</h3>";
        html += "<table>";
        html += "<thead><tr><th>Year</th><th>Cabang</th><th>Total Cash</th><th>Total Credit</th></tr></thead><tbody>";
        for (const year in group) {
          for (const cabang in group[year]) {
            const cash = group[year][cabang].cash;
            const credit = group[year][cabang].credit;
            html += `<tr>
                       <td>${year}</td>
                       <td>${cabang}</td>
                       <td><span class="dashboard-value">${formatNumber(cash)}</span></td>
                       <td><span class="dashboard-value">${formatNumber(credit)}</span></td>
                     </tr>`;
          }
        }
        html += "</tbody></table>";
        summaryDiv.innerHTML = html;
      }

      document.getElementById("toggleFilterBtn").addEventListener("click", function () {
        const filterSection = document.getElementById("filterSection");
        const toggleBtn = document.getElementById("toggleFilterBtn");
        if (filterSection.style.display === "none") {
          filterSection.style.display = "block";
          toggleBtn.textContent = "Sembunyikan Filter";
        } else {
          filterSection.style.display = "none";
          toggleBtn.textContent = "Tampilkan Filter";
        }
      });

      // Fungsi untuk menyembunyikan semua view utama
      function hideAllViews() {
        const views = [
          "dashboard-view",
          "kpi-view",
          "laporan-view",
          "sheet3-view",
          "trialbalance-view",
          "tbReport-view",
          "incomestatement-view",
          "statementcashflows-view",
          "inventoryreconciliation-view",
          "potential-sales-claim-revenue-view",
          "isauditcontrol-view",
          "salesAnalysis-view",
          "trenSales-view",
          "achievement-view",
          "inputTargetSales-view"
        ];
        views.forEach(id => {
          document.getElementById(id).style.display = "none";
        });
      }

      // Fungsi untuk mengisi dropdown filter PT di Report View (Trial Balance Report)
      function populatePtReportSelect() {
        if (!ledgerMutationData || ledgerMutationData.length < 2) {
          document.getElementById("ptReportSelectContainer").innerHTML = "<p>No PT data available.</p>";
          return;
        }
        const header = ledgerMutationData[0];
        let ptIndex = -1;
        for (let i = 0; i < header.length; i++) {
          if (String(header[i]).trim().toLowerCase() === "pt") {
            ptIndex = i;
            break;
          }
        }
        if (ptIndex === -1) {
          document.getElementById("ptReportSelectContainer").innerHTML = "<p>Kolom 'pt' tidak ditemukan.</p>";
          return;
        }
        const distinctPts = [];
        for (let i = 1; i < ledgerMutationData.length; i++) {
          const ptValue = ledgerMutationData[i][ptIndex];
          if (ptValue && !distinctPts.includes(ptValue)) {
            distinctPts.push(ptValue);
          }
        }
        let selectHtml = '<label for="ptReportSelect">Pilih PT: </label>';
        selectHtml += '<select id="ptReportSelect">';
        selectHtml += '<option value="">Semua</option>';
        distinctPts.forEach(pt => {
          selectHtml += `<option value="${pt}">${pt}</option>`;
        });
        selectHtml += '</select>';
        document.getElementById("ptReportSelectContainer").innerHTML = selectHtml;

        // Ketika dropdown berubah, render ulang report
        document.getElementById("ptReportSelect").addEventListener("change", function () {
          renderTrialBalanceReport();
        });
      }

      // Fungsi untuk merender Report Trial Balance (tetap sama)
      function renderTrialBalanceReport() {
        if (!ledgerMutationData || ledgerMutationData.length < 2) {
          document.getElementById("tbReportTableContainer").innerHTML = "<p>No data available.</p>";
          return;
        }
        const header = ledgerMutationData[0];
        let indexAcc = -1, indexPT = -1, indexYear = -1, indexSaldo = -1;
        for (let i = 0; i < header.length; i++) {
          const col = String(header[i]).trim().toLowerCase();
          if (col === "acc code" || col === "gl acc1") { indexAcc = i; }
          if (col === "pt") { indexPT = i; }
          if (col === "year" || col === "tahun") { indexYear = i; }
          if (col === "saldo akhir") { indexSaldo = i; }
        }
        if (indexAcc === -1 || indexPT === -1 || indexYear === -1 || indexSaldo === -1) {
          document.getElementById("tbReportTableContainer").innerHTML = "<p>Kolom yang diperlukan tidak ditemukan di data TB.</p>";
          return;
        }
        // Ambil filter PT dari dropdown
        const ptSelect = document.getElementById("ptReportSelect");
        let selectedPT = ptSelect ? ptSelect.value : "";
        const yearsToInclude = ["2023", "2024", "2025", "2026", "2027"];
        // Grouping data: key = accCode, value = object { "2023": total, ... }
        const reportData = {};
        for (let i = 1; i < ledgerMutationData.length; i++) {
          const row = ledgerMutationData[i];
          const accCode = row[indexAcc] ? String(row[indexAcc]).trim() : "";
          const ptValue = row[indexPT] ? String(row[indexPT]).trim() : "";
          const yearValue = row[indexYear] ? String(row[indexYear]).trim() : "";
          const saldo = parseFloat(row[indexSaldo]) || 0;
          // Filter PT jika diterapkan
          if (selectedPT && ptValue !== selectedPT) continue;
          // Hanya proses tahun yang diinginkan
          if (!yearsToInclude.includes(yearValue)) continue;
          if (!accCode) continue;
          if (!reportData[accCode]) {
            reportData[accCode] = { "2023": 0, "2024": 0, "2025": 0, "2026": 0, "2027": 0 };
          }
          reportData[accCode][yearValue] += saldo;
        }
        // Tentukan akun yang diinginkan untuk tabel pertama
        const desiredAccounts = ["PJ", "Rp", "PP"];
        desiredAccounts.forEach(code => {
          if (reportData[code] === undefined) {
            reportData[code] = { "2023": 0, "2024": 0, "2025": 0, "2026": 0, "2027": 0 };
          }
        });
        // Pisahkan akun desired dan akun HPP
        const desiredCodes = desiredAccounts;
        let hppValues = reportData["HPP"] || { "2023": 0, "2024": 0, "2025": 0, "2026": 0, "2027": 0 };
        // --- Tabel Desired (PJ, Rp, PP) + Total Penjualan Bersih ---
        let tableHtml1 = "<table id='tbReport-table-1'><thead><tr>";
        tableHtml1 += "<th id='report-header'>Acc Code</th>";
        yearsToInclude.forEach(year => {
          tableHtml1 += `<th>${year}</th>`;
        });
        tableHtml1 += "</tr></thead><tbody>";
        desiredCodes.forEach(accCode => {
          tableHtml1 += "<tr>";
          tableHtml1 += `<td>${accCode}</td>`;
          yearsToInclude.forEach(year => {
            let value = reportData[accCode][year];
            if (accCode === "PJ") {
              if (value < 0) { value = Math.abs(value); }
            } else if (accCode === "Rp" || accCode === "PP") {
              if (value > 0) { value = -value; }
            }
            tableHtml1 += `<td>${formatNumber(value)}</td>`;
          });
          tableHtml1 += "</tr>";
        });
        const totalPenjualanBersih = { "2023": 0, "2024": 0, "2025": 0, "2026": 0, "2027": 0 };
        yearsToInclude.forEach(year => {
          let pjVal = reportData["PJ"][year];
          if (pjVal < 0) { pjVal = Math.abs(pjVal); }
          let rpVal = reportData["Rp"][year];
          if (rpVal > 0) { rpVal = -rpVal; }
          let ppVal = reportData["PP"][year];
          if (ppVal > 0) { ppVal = -ppVal; }
          totalPenjualanBersih[year] = pjVal + rpVal + ppVal;
        });
        tableHtml1 += "<tr>";
        tableHtml1 += "<td>Total Penjualan Bersih</td>";
        yearsToInclude.forEach(year => {
          tableHtml1 += `<td>${formatNumber(totalPenjualanBersih[year])}</td>`;
        });
        tableHtml1 += "</tr>";
        tableHtml1 += "</tbody></table>";

        // --- Tabel HPP ---
        let tableHtmlHpp = "<table id='tbReport-table-hpp'><thead><tr>";
        tableHtmlHpp += "<th id='report-header'>Acc Code</th>";
        yearsToInclude.forEach(year => {
          tableHtmlHpp += `<th>${year}</th>`;
        });
        tableHtmlHpp += "</tr></thead><tbody>";
        tableHtmlHpp += `<tr><td>HPP</td>`;
        yearsToInclude.forEach(year => {
          tableHtmlHpp += `<td>${formatNumber(hppValues[year])}</td>`;
        });
        tableHtmlHpp += "</tr>";
        tableHtmlHpp += "</tbody></table>";

        // --- Tabel Laba Kotor (Total Penjualan Bersih - HPP) ---
        let tableHtmlLabaKotor = "<table id='tbReport-table-labaKotor'><thead><tr>";
        tableHtmlLabaKotor += "<th id='report-header'>Acc Code</th>";
        yearsToInclude.forEach(year => {
          tableHtmlLabaKotor += `<th>${year}</th>`;
        });
        tableHtmlLabaKotor += "</tr></thead><tbody>";
        tableHtmlLabaKotor += `<tr><td>Laba Kotor</td>`;
        yearsToInclude.forEach(year => {
          let labaKotor = totalPenjualanBersih[year] - hppValues[year];
          tableHtmlLabaKotor += `<td>${formatNumber(labaKotor)}</td>`;
        });
        tableHtmlLabaKotor += "</tr>";
        tableHtmlLabaKotor += "</tbody></table>";

        // --- Tabel Biaya Operasional (BP, BAU, By Oprasional = BP+BAU) ---
        let bpValues = reportData["BP"] || { "2023": 0, "2024": 0, "2025": 0, "2026": 0, "2027": 0 };
        let bauValues = reportData["BAU"] || { "2023": 0, "2024": 0, "2025": 0, "2026": 0, "2027": 0 };

        let tableHtmlBiayaOperasional = "<table id='tbReport-table-biayaOperasional'><thead><tr>";
        tableHtmlBiayaOperasional += "<th id='report-header'>Acc Code</th>";
        yearsToInclude.forEach(year => {
          tableHtmlBiayaOperasional += `<th>${year}</th>`;
        });
        tableHtmlBiayaOperasional += "</tr></thead><tbody>";
        // Baris BP
        tableHtmlBiayaOperasional += `<tr><td>BP</td>`;
        yearsToInclude.forEach(year => {
          tableHtmlBiayaOperasional += `<td>${formatNumber(bpValues[year])}</td>`;
        });
        tableHtmlBiayaOperasional += "</tr>";
        // Baris BAU
        tableHtmlBiayaOperasional += `<tr><td>BAU</td>`;
        yearsToInclude.forEach(year => {
          tableHtmlBiayaOperasional += `<td>${formatNumber(bauValues[year])}</td>`;
        });
        tableHtmlBiayaOperasional += "</tr>";
        // Baris By Oprasional = BP + BAU
        tableHtmlBiayaOperasional += `<tr><td>By Oprasional</td>`;
        yearsToInclude.forEach(year => {
          let byOprasional = (bpValues[year] || 0) + (bauValues[year] || 0);
          tableHtmlBiayaOperasional += `<td>${formatNumber(byOprasional)}</td>`;
        });
        tableHtmlBiayaOperasional += "</tr>";
        tableHtmlBiayaOperasional += "</tbody></table>";

        // --- Tabel Laba Oprasional = Laba Kotor - (BP+BAU) ---
        let tableHtmlLabaOprasional = "<table id='tbReport-table-labaOprasional'><thead><tr>";
        tableHtmlLabaOprasional += "<th id='report-header'>Acc Code</th>";
        yearsToInclude.forEach(year => {
          tableHtmlLabaOprasional += `<th>${year}</th>`;
        });
        tableHtmlLabaOprasional += "</tr></thead><tbody>";
        tableHtmlLabaOprasional += `<tr><td>Laba Oprasional</td>`;
        yearsToInclude.forEach(year => {
          let byOprasional = (bpValues[year] || 0) + (bauValues[year] || 0);
          let labaOprasional = (totalPenjualanBersih[year] - hppValues[year]) - byOprasional;
          tableHtmlLabaOprasional += `<td>${formatNumber(labaOprasional)}</td>`;
        });
        tableHtmlLabaOprasional += "</tr>";
        tableHtmlLabaOprasional += "</tbody></table>";

        // --- Tabel Pendapatan Biaya Luar Usaha ---
        let pluValues = reportData["PLU"] || { "2023": 0, "2024": 0, "2025": 0, "2026": 0, "2027": 0 };
        let bluValues = reportData["BLU"] || { "2023": 0, "2024": 0, "2025": 0, "2026": 0, "2027": 0 };
        let tableHtmlPendapatanLuarUsaha = "<table id='tbReport-table-pendapatanLuarUsaha'><thead><tr>";
        tableHtmlPendapatanLuarUsaha += "<th id='report-header'>Acc Code</th>";
        yearsToInclude.forEach(year => {
          tableHtmlPendapatanLuarUsaha += `<th>${year}</th>`;
        });
        tableHtmlPendapatanLuarUsaha += "</tr></thead><tbody>";
        tableHtmlPendapatanLuarUsaha += `<tr><td>PLU</td>`;
        yearsToInclude.forEach(year => {
          let pluVal = pluValues[year] || 0;
          if (pluVal < 0) { pluVal = Math.abs(pluVal); }
          tableHtmlPendapatanLuarUsaha += `<td>${formatNumber(pluVal)}</td>`;
        });
        tableHtmlPendapatanLuarUsaha += "</tr>";
        tableHtmlPendapatanLuarUsaha += `<tr><td>BLU</td>`;
        yearsToInclude.forEach(year => {
          let bluVal = bluValues[year] || 0;
          if (bluVal > 0) bluVal = -bluVal;
          tableHtmlPendapatanLuarUsaha += `<td>${formatNumber(bluVal)}</td>`;
        });
        tableHtmlPendapatanLuarUsaha += "</tr>";
        tableHtmlPendapatanLuarUsaha += `<tr><td>Pendapatan Biaya Luar Usaha</td>`;
        yearsToInclude.forEach(year => {
          let pluVal = pluValues[year] || 0;
          if (pluVal < 0) { pluVal = Math.abs(pluVal); }
          let bluVal = bluValues[year] || 0;
          if (bluVal > 0) bluVal = -bluVal;
          let pendapatanLuar = pluVal + bluVal;
          tableHtmlPendapatanLuarUsaha += `<td>${formatNumber(pendapatanLuar)}</td>`;
        });
        tableHtmlPendapatanLuarUsaha += "</tr>";
        tableHtmlPendapatanLuarUsaha += "</tbody></table>";

        // --- Tabel Laba/Rugi = Laba Oprasional + (Pendapatan Biaya Luar Usaha) ---
        let tableHtmlLabaRugi = "<table id='tbReport-table-labaRugi'><thead><tr>";
        tableHtmlLabaRugi += "<th id='report-header'>Acc Code</th>";
        yearsToInclude.forEach(year => {
          tableHtmlLabaRugi += `<th>${year}</th>`;
        });
        tableHtmlLabaRugi += "</tr></thead><tbody>";
        tableHtmlLabaRugi += `<tr><td>Laba/Rugi</td>`;
        yearsToInclude.forEach(year => {
          let byOprasional = (bpValues[year] || 0) + (bauValues[year] || 0);
          let labaOprasional = (totalPenjualanBersih[year] - hppValues[year]) - byOprasional;
          let pendapatanLuar = (pluValues[year] || 0);
          if (pendapatanLuar < 0) { pendapatanLuar = Math.abs(pendapatanLuar); }
          let bluVal = bluValues[year] || 0;
          if (bluVal > 0) bluVal = -bluVal;
          pendapatanLuar += bluVal;
          let labaRugi = labaOprasional + pendapatanLuar;
          tableHtmlLabaRugi += `<td>${formatNumber(labaRugi)}</td>`;
        });
        tableHtmlLabaRugi += "</tr>";
        tableHtmlLabaRugi += "</tbody></table>";

        // --- Tampilkan Semua Tabel ---
        document.getElementById("tbReportTableContainer").innerHTML =
          tableHtml1 +
          tableHtmlHpp +
          tableHtmlLabaKotor +
          tableHtmlBiayaOperasional +
          tableHtmlLabaOprasional +
          tableHtmlPendapatanLuarUsaha +
          tableHtmlLabaRugi;
      }

      // === Fungsi Khusus Sales Analysis dengan Checkbox Filter ===
      function populateSalesAnalysisFilters() {
        const container = document.getElementById("salesAnalysis-filter-container");
        container.innerHTML = "";
        // Container untuk filter Tahun
        const yearsDiv = document.createElement("div");
        yearsDiv.className = "filter-group";
        const yearsLabel = document.createElement("label");
        yearsLabel.innerHTML = "<strong>Pilih Tahun:</strong>";
        yearsDiv.appendChild(yearsLabel);
        // Container untuk filter Cabang
        const cabangDiv = document.createElement("div");
        cabangDiv.className = "filter-group";
        const cabangLabel = document.createElement("label");
        cabangLabel.innerHTML = "<strong>Pilih Cabang:</strong>";
        cabangDiv.appendChild(cabangLabel);
        if (!sheet2Data || sheet2Data.length < 2) return;
        const years = new Set();
        const cabangs = new Set();
        for (let i = 1; i < sheet2Data.length; i++) {
          const row = sheet2Data[i];
          if (row[0]) years.add(row[0]);
          if (row[1]) cabangs.add(row[1]);
        }
        years.forEach(year => {
          const label = document.createElement("label");
          label.style.marginRight = "10px";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = year;
          checkbox.className = "salesAnalysisYearCheckbox";
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(" " + year));
          yearsDiv.appendChild(label);
        });
        cabangs.forEach(cabang => {
          const label = document.createElement("label");
          label.style.marginRight = "10px";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = cabang;
          checkbox.className = "salesAnalysisCabangCheckbox";
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(" " + cabang));
          cabangDiv.appendChild(label);
        });
        container.appendChild(yearsDiv);
        container.appendChild(cabangDiv);
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.id = "salesAnalysisApplyFilter";
        btn.textContent = "Show";
        btn.addEventListener("click", () => {
          renderSalesAnalysis();
          renderSalesAnalysisCharts();
        });
        container.appendChild(btn);
      }

      // Perbarui Fungsi renderSalesAnalysis untuk menambahkan kolom perhitungan baru
      function renderSalesAnalysis() {
        if (!sheet2Data || sheet2Data.length < 2) {
          document.querySelector("#salesAnalysis-view tbody").innerHTML = "<tr><td colspan='7'>No data available.</td></tr>";
          return;
        }
        const yearCheckboxes = document.querySelectorAll(".salesAnalysisYearCheckbox:checked");
        const selectedYears = Array.from(yearCheckboxes).map(cb => cb.value);
        const cabangCheckboxes = document.querySelectorAll(".salesAnalysisCabangCheckbox:checked");
        const selectedCabangs = Array.from(cabangCheckboxes).map(cb => cb.value);
        let html = "";
        for (let i = 1; i < sheet2Data.length; i++) {
          const row = sheet2Data[i];
          const year = row[0] || "";
          const cabang = row[1] || "";
          if ((selectedYears.length > 0 && !selectedYears.includes(year)) ||
              (selectedCabangs.length > 0 && !selectedCabangs.includes(cabang))) {
            continue;
          }
          const marginUnit = Number(row[2]) || 0;
          const grossProfitSetelahSub = Number(row[4]) || 0;
          const potDealer = Number(row[5]) || 0;
          const potTambahan = Number(row[6]) || 0;
          const broker = Number(row[10]) || 0;
          const totalPotongan = potDealer + potTambahan + broker;
          const persentasePotongan = grossProfitSetelahSub !== 0 ? (totalPotongan / grossProfitSetelahSub) * 100 : 0;
          const rasioProfitabilitas = marginUnit !== 0 ? (grossProfitSetelahSub / marginUnit) : 0;
          const persentaseFormatted = persentasePotongan.toFixed(2) + " %";
          html += "<tr>";
          html += `<td>${year}</td>`;
          html += `<td>${cabang}</td>`;
          html += `<td>${formatNumber(marginUnit)}</td>`;
          html += `<td>${formatNumber(grossProfitSetelahSub)}</td>`;
          html += `<td>${formatNumber(totalPotongan)}</td>`;
          html += `<td>${persentaseFormatted}</td>`;
          html += `<td>${rasioProfitabilitas.toFixed(2)}</td>`;
          html += "</tr>";
        }
        document.querySelector("#salesAnalysis-view tbody").innerHTML = html;
      }

      // Fungsi untuk merender grafik Sales Analysis
      function renderSalesAnalysisCharts() {
        const yearCheckboxes = document.querySelectorAll(".salesAnalysisYearCheckbox:checked");
        const selectedYears = Array.from(yearCheckboxes).map(cb => cb.value);
        const cabangCheckboxes = document.querySelectorAll(".salesAnalysisCabangCheckbox:checked");
        const selectedCabangs = Array.from(cabangCheckboxes).map(cb => cb.value);
        const aggregated = {};
        for (let i = 1; i < sheet2Data.length; i++) {
          const row = sheet2Data[i];
          const year = row[0] || "";
          const cabang = row[1] || "";
          if ((selectedYears.length > 0 && !selectedYears.includes(year)) ||
              (selectedCabangs.length > 0 && !selectedCabangs.includes(cabang))) {
            continue;
          }
          const marginUnit = Number(row[2]) || 0;
          const grossProfit = Number(row[4]) || 0;
          const potDealer = Number(row[5]) || 0;
          const potTambahan = Number(row[6]) || 0;
          const broker = Number(row[10]) || 0;
          const totalPotongan = potDealer + potTambahan + broker;
          if (!aggregated[cabang]) {
            aggregated[cabang] = { marginUnit: 0, grossProfit: 0, totalPotongan: 0 };
          }
          aggregated[cabang].marginUnit += marginUnit;
          aggregated[cabang].grossProfit += grossProfit;
          aggregated[cabang].totalPotongan += totalPotongan;
        }
        const cabangLabels = Object.keys(aggregated);
        const profitabilityValues = [];
        const discountPercentageValues = [];
        cabangLabels.forEach(cabang => {
          const data = aggregated[cabang];
          const profitability = data.marginUnit !== 0 ? data.grossProfit / data.marginUnit : 0;
          const discountPercentage = data.grossProfit !== 0 ? (data.totalPotongan / data.grossProfit) * 100 : 0;
          profitabilityValues.push(Number(profitability.toFixed(2)));
          discountPercentageValues.push(Number(discountPercentage.toFixed(2)));
        });
        if (salesAnalysisProfitabilityChart) {
          salesAnalysisProfitabilityChart.destroy();
        }
        if (salesAnalysisDiscountChart) {
          salesAnalysisDiscountChart.destroy();
        }
        const ctxProfit = document.getElementById("profitabilityChart").getContext("2d");
        salesAnalysisProfitabilityChart = new Chart(ctxProfit, {
          type: "bar",
          data: {
            labels: cabangLabels,
            datasets: [{
              label: "Rasio Profitabilitas",
              data: profitabilityValues,
              backgroundColor: "rgba(54, 162, 235, 0.5)",
              borderColor: "rgba(54, 162, 235, 1)",
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: "Rasio Profitabilitas Per Cabang"
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ": " + context.parsed.y.toFixed(2);
                  }
                }
              }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
        const ctxDiscount = document.getElementById("discountPercentageChart").getContext("2d");
        salesAnalysisDiscountChart = new Chart(ctxDiscount, {
          type: "bar",
          data: {
            labels: cabangLabels,
            datasets: [{
              label: "Persentase Potongan (%)",
              data: discountPercentageValues,
              backgroundColor: "rgba(255, 99, 132, 0.5)",
              borderColor: "rgba(255, 99, 132, 1)",
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: "Persentase Potongan Per Cabang"
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ": " + context.parsed.y.toFixed(2) + " %";
                  }
                }
              }
            },
            scales: { y: { beginAtZero: true } }
          }
        });
      }

      // Fungsi untuk merender grafik Line pada Tren Sales (tanpa filter)
      function renderTrenSalesChart() {
        if (!sheet2Data || sheet2Data.length < 2) {
          document.getElementById("trenSales-view").innerHTML = "<p>Tidak ada data untuk ditampilkan.</p>";
          return;
        }
        // Grafik Line selalu gunakan seluruh data tanpa filter
        let yearsSet = new Set();
        let trendData = {};
        for (let i = 1; i < sheet2Data.length; i++) {
          let row = sheet2Data[i];
          let year = row[0];
          let branch = row[1];
          let marginUnit = Number(row[2]) || 0;
          yearsSet.add(year);
          if (!trendData[branch]) {
            trendData[branch] = {};
          }
          if (!trendData[branch][year]) {
            trendData[branch][year] = 0;
          }
          trendData[branch][year] += marginUnit;
        }
        let years = Array.from(yearsSet).sort();
        let datasets = [];
        Object.keys(trendData).forEach(branch => {
          let dataPoints = years.map(y => trendData[branch][y] || 0);
          let r = Math.floor(Math.random() * 156) + 100;
          let g = Math.floor(Math.random() * 156) + 100;
          let b = Math.floor(Math.random() * 156) + 100;
          let color = `rgba(${r}, ${g}, ${b}, 0.8)`;
          datasets.push({
            label: branch,
            data: dataPoints,
            fill: false,
            borderColor: color,
            backgroundColor: color,
            tension: 0.1
          });
        });
        let ctx = document.getElementById("trenSalesChart").getContext("2d");
        if (trenSalesChartInstance) {
          trenSalesChartInstance.destroy();
        }
        trenSalesChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: years,
            datasets: datasets
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: 'Tren Sales Berdasarkan Margin Unit Per Cabang (Seluruh Data)'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ": " + context.parsed.y.toLocaleString();
                  }
                }
              }
            },
            scales: {
              x: { title: { display: true, text: 'Tahun' } },
              y: { title: { display: true, text: 'Margin Unit' }, beginAtZero: true }
            }
          }
        });
      }

      // Fungsi untuk merender grafik Bar pada Tren Sales: X = Cabang, Y = Total Margin
      function renderTrenSalesBarChart() {
        if (!sheet2Data || sheet2Data.length < 2) {
          document.getElementById("trenSales-view").innerHTML += "<p>Tidak ada data untuk ditampilkan.</p>";
          return;
        }
        // Dapatkan tahun yang dipilih dari filter khusus grafik Bar
        const selectedYearCheckboxes = document.querySelectorAll("#trenSalesBarFilterContainer .trenSalesYearCheckbox:checked");
        let selectedYears = Array.from(selectedYearCheckboxes).map(cb => cb.value);
        if (selectedYears.length === 0) {
          for (let i = 1; i < sheet2Data.length; i++) {
            let year = sheet2Data[i][0];
            if (year && !selectedYears.includes(year)) selectedYears.push(year);
          }
          selectedYears.sort();
        }
        // Agregasi data margin per Cabang berdasarkan filter tahun
        const branchMargin = {};
        for (let i = 1; i < sheet2Data.length; i++) {
          const row = sheet2Data[i];
          const year = row[0];
          if (!selectedYears.includes(year)) continue;
          const cabang = row[1] || "Unknown";
          const margin = Number(row[2]) || 0;
          if (!branchMargin[cabang]) {
            branchMargin[cabang] = 0;
          }
          branchMargin[cabang] += margin;
        }
        const labels = Object.keys(branchMargin);
        const dataMargin = Object.values(branchMargin);
        if (trenSalesBarChartInstance) {
          trenSalesBarChartInstance.destroy();
        }
        const ctx = document.getElementById("trenSalesBarChart").getContext("2d");
        trenSalesBarChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Total Margin per Cabang',
              data: dataMargin,
              backgroundColor: 'rgba(75, 192, 192, 0.5)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: 'Grafik Total Margin per Cabang (Berdasarkan Filter Tahun)'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ": " + context.parsed.y.toLocaleString();
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Nilai Margin' }
              },
              x: {
                title: { display: true, text: 'Cabang' }
              }
            }
          }
        });
      }

      // Fungsi untuk mem-popuplate filter khusus untuk grafik Bar pada Tren Sales
      function populateTrenSalesBarYearFilter() {
        const container = document.getElementById("trenSalesBarFilterContainer");
        container.innerHTML = "<strong>Pilih Tahun:</strong> ";
        let years = new Set();
        for (let i = 1; i < sheet2Data.length; i++) {
          let year = sheet2Data[i][0];
          if (year) years.add(year);
        }
        years = Array.from(years).sort();
        years.forEach(year => {
          const label = document.createElement("label");
          label.style.marginRight = "10px";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = year;
          checkbox.className = "trenSalesYearCheckbox";
          checkbox.checked = true;
          checkbox.addEventListener("change", renderTrenSalesBarChart);
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(" " + year));
          container.appendChild(label);
        });
      }

      // Navigasi Sidebar
      document.getElementById("uploadDataLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("laporan-view").style.display = "block";
        document.getElementById("upload").click();
      });
      document.getElementById("tbUploadLink").addEventListener("click", function (e) {
        e.preventDefault();
        document.getElementById("uploadTB").click();
      });
      document.getElementById("tbReportLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("tbReport-view").style.display = "block";
        populatePtReportSelect();
        renderTrialBalanceReport();
      });
      document.getElementById("dashboardLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("dashboard-view").style.display = "block";
        renderDashboardSalesSummary();
        renderDashboardCashCreditSummary();
      });
      document.getElementById("kpiLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("kpi-view").style.display = "block";
      });
      document.getElementById("laporanPenjualanLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("laporan-view").style.display = "block";
      });
      document.getElementById("salesAnalysisLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("salesAnalysis-view").style.display = "block";
        populateSalesAnalysisFilters();
        renderSalesAnalysis();
        renderSalesAnalysisCharts();
      });
      document.getElementById("trenSalesLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("trenSales-view").style.display = "block";
        // Untuk grafik Line, gunakan seluruh data tanpa filter
        renderTrenSalesChart();
        // Untuk grafik Bar, tampilkan filter khusus dan render grafik Bar berdasarkan filter
        populateTrenSalesBarYearFilter();
        renderTrenSalesBarChart();
      });
      document.getElementById("achievementLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("achievement-view").style.display = "block";
      });
      document.getElementById("inputTargetSalesLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("inputTargetSales-view").style.display = "block";
      });
      document.getElementById("isauditcontrolLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("isauditcontrol-view").style.display = "block";
      });
      document.getElementById("trialbalanceLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("trialbalance-view").style.display = "block";
        if (ledgerMutationData && ledgerMutationData.length > 0) {
          populateTrialBalanceFilters();
          renderTrialBalance();
        }
      });
      document.getElementById("incomestatementLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("incomestatement-view").style.display = "block";
      });
      document.getElementById("statementcashflowsLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("statementcashflows-view").style.display = "block";
      });
      document.getElementById("inventoryReconciliationLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("inventoryreconciliation-view").style.display = "block";
      });
      document.getElementById("potentialSalesClaimRevenueLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("potential-sales-claim-revenue-view").style.display = "block";
        const selectedYears = Array.from(document.querySelectorAll('#yearFilterContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedCabangs = Array.from(document.querySelectorAll('#ptFilterContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        let filteredSheet4 = sheet4Data.slice(2);
        if (selectedYears.length > 0) {
          filteredSheet4 = filteredSheet4.filter(row => selectedYears.includes(String(row[0])));
        }
        if (selectedCabangs.length > 0) {
          filteredSheet4 = filteredSheet4.filter(row => selectedCabangs.includes(String(row[1])));
        }
        if (filteredSheet4.length > 0) {
          renderSheet4Table(filteredSheet4);
        } else {
          document.getElementById("sheet4TableBody").innerHTML = "<tr><td colspan='15'>No data available in Sheet4</td></tr>";
        }
      });
      document.getElementById("salesCashCreditLink").addEventListener("click", function (e) {
        e.preventDefault();
        hideAllViews();
        document.getElementById("sheet3-view").style.display = "block";
        populateSheet3Filters();
        applySheet3Filters();
      });

      // Fungsi untuk menangani file laporan penjualan
      document.getElementById("upload").addEventListener("change", handleFile);
      function handleFile(event) {
        localStorage.removeItem("jsonData");
        localStorage.removeItem("sheet2Data");
        localStorage.removeItem("sheet3Data");
        localStorage.removeItem("sheet4Data");
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function (e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          const secondSheet = workbook.Sheets[workbook.SheetNames[1]];
          sheet2Data = XLSX.utils.sheet_to_json(secondSheet, { header: 1 });
          if (workbook.SheetNames.length >= 3) {
            const thirdSheet = workbook.Sheets[workbook.SheetNames[2]];
            sheet3Data = XLSX.utils.sheet_to_json(thirdSheet, { header: 1 });
            localStorage.setItem("sheet3Data", JSON.stringify(sheet3Data));
          } else {
            sheet3Data = [];
            localStorage.removeItem("sheet3Data");
          }
          if (workbook.SheetNames.length >= 4) {
            const fourthSheet = workbook.Sheets[workbook.SheetNames[3]];
            sheet4Data = XLSX.utils.sheet_to_json(fourthSheet, { header: 1 });
            localStorage.setItem("sheet4Data", JSON.stringify(sheet4Data));
          } else {
            sheet4Data = [];
            localStorage.removeItem("sheet4Data");
          }
          localStorage.setItem("jsonData", JSON.stringify(jsonData));
          localStorage.setItem("sheet2Data", JSON.stringify(sheet2Data));
          const rows = jsonData.slice(2);
          populateFilters(rows);
          renderTable(rows);
          updateSalesChart(rows);
          const sheet2Rows = sheet2Data.slice(1);
          renderSheet2Table(sheet2Rows);
          updateSheet2Chart(sheet2Rows);
        };
        reader.readAsArrayBuffer(file);
      }

      // Fungsi untuk menangani file TB (Ledger_Mutation)
      document.getElementById("uploadTB").addEventListener("change", handleTBFile);
      function handleTBFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          if (!workbook.SheetNames.includes("Ledger_Mutation")) {
            alert("Sheet 'Ledger_Mutation' tidak ditemukan pada file!");
            return;
          }
          const tbSheet = workbook.Sheets["Ledger_Mutation"];
          ledgerMutationData = XLSX.utils.sheet_to_json(tbSheet, { header: 1 });
          localStorage.setItem("ledgerMutationData", JSON.stringify(ledgerMutationData));
          alert("File TB berhasil diupload!");
          populateTrialBalanceFilters();
          renderTrialBalance();
          hideAllViews();
          document.getElementById("trialbalance-view").style.display = "block";
        };
        reader.readAsArrayBuffer(file);
      }

      // Fungsi untuk mengisi filter di halaman laporan penjualan (utama)
      function populateFilters(data) {
        const yearContainer = document.getElementById("yearFilterContainer");
        const ptContainer = document.getElementById("ptFilterContainer");
        yearContainer.innerHTML = "";
        ptContainer.innerHTML = "";
        const years = [...new Set(data.map(row => row[0]))].filter(year => year);
        const pts = [...new Set(data.map(row => row[1]))].filter(pt => pt);
        years.forEach(year => {
          const label = document.createElement("label");
          label.style.marginRight = "10px";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = year;
          checkbox.className = "yearCheckbox";
          checkbox.addEventListener("change", applyUnifiedFilter);
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(" " + year));
          yearContainer.appendChild(label);
        });
        pts.forEach(pt => {
          const label = document.createElement("label");
          label.style.marginRight = "10px";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = pt;
          checkbox.className = "ptCheckbox";
          checkbox.addEventListener("change", applyUnifiedFilter);
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(" " + pt));
          ptContainer.appendChild(label);
        });
      }

      function applyUnifiedFilter() {
        const selectedYears = Array.from(document.querySelectorAll('#yearFilterContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedCabangs = Array.from(document.querySelectorAll('#ptFilterContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        let filteredDataSheet1 = jsonData.slice(2);
        if (selectedYears.length > 0) {
          filteredDataSheet1 = filteredDataSheet1.filter(row => selectedYears.includes(String(row[0])));
        }
        if (selectedCabangs.length > 0) {
          filteredDataSheet1 = filteredDataSheet1.filter(row => selectedCabangs.includes(String(row[1])));
        }
        let filteredDataSheet2 = sheet2Data.slice(1);
        if (selectedYears.length > 0) {
          filteredDataSheet2 = filteredDataSheet2.filter(row => selectedYears.includes(String(row[0])));
        }
        if (selectedCabangs.length > 0) {
          filteredDataSheet2 = filteredDataSheet2.filter(row => selectedCabangs.includes(String(row[1])));
        }
        renderTable(filteredDataSheet1);
        updateSalesChart(filteredDataSheet1);
        renderSheet2Table(filteredDataSheet2);
        updateSheet2Chart(filteredDataSheet2);
      }

      function renderTable(data) {
        const tableBody = document.querySelector("#data-table tbody");
        tableBody.innerHTML = "";
        data.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = row.map(cell => `<td>${cell !== undefined && cell !== null ? cell : 0}</td>`).join("");
          tableBody.appendChild(tr);
        });
      }

      function renderSheet2Table(data) {
        const table = document.getElementById("sheet2-table");
        if (!table) return;
        const tableBody = table.querySelector("tbody");
        tableBody.innerHTML = "";
        const headerCell = table.querySelector("thead tr:first-child th");
        const years = data.map(row => row[0]).filter(Boolean);
        const uniqueYears = [...new Set(years)];
        let headerText = "Cumulative Margin and Diskon";
        if (uniqueYears.length === 1) {
          headerText += ` (${uniqueYears[0]})`;
        } else if (uniqueYears.length > 1) {
          headerText += ` (${uniqueYears.join(", ")})`;
        }
        headerCell.textContent = headerText;
        data.forEach(row => {
          const [year, cabang, marginUnit, sisaMargin, grossProfitSetelahSub, potDealer, potTambahan, potLeasing, potATPM, potMD, broker] = row;
          const tr = document.createElement("tr");
          tr.innerHTML = 
            `<td>${year || "-"}</td>
             <td>${cabang || "-"}</td>
             <td>${Number(marginUnit || 0).toLocaleString('en-US')}</td>
             <td>${Number(grossProfitSetelahSub || 0).toLocaleString('en-US')}</td>
             <td>${Number(potDealer || 0).toLocaleString('en-US')}</td>
             <td>${Number(potTambahan || 0).toLocaleString('en-US')}</td>
             <td>${Number(potLeasing || 0).toLocaleString('en-US')}</td>
             <td>${Number(potATPM || 0).toLocaleString('en-US')}</td>
             <td>${Number(potMD || 0).toLocaleString('en-US')}</td>
             <td>${Number(broker || 0).toLocaleString('en-US')}</td>`;
          tableBody.appendChild(tr);
        });
      }

      function updateSalesChart(data) {
        const branchTotals = {};
        data.forEach(row => {
          const branch = row[1] || "Unknown";
          const total = Number(row[14] || 0);
          branchTotals[branch] = (branchTotals[branch] || 0) + total;
        });
        const labels = Object.keys(branchTotals);
        const totals = Object.values(branchTotals);
        if (chartInstance) {
          chartInstance.destroy();
        }
        const ctx = document.getElementById("salesChart").getContext("2d");
        chartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Total Penjualan",
                data: totals,
                backgroundColor: "rgba(74, 144, 226, 0.5)",
                borderColor: "rgba(74, 144, 226, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { title: { display: true, text: "Total Penjualan" } },
            scales: { y: { beginAtZero: true } },
          },
        });
      }

      function updateSheet2Chart(data) {
        const labels = data.map(row => row[1]);
        const marginUnits = data.map(row => Number(row[2] || 0));
        const sisaMargins = data.map(row => Number(row[3] || 0));
        const grossProfitSetelahSubs = data.map(row => Number(row[4] || 0));
        const potDealers = data.map(row => Number(row[5] || 0));
        const potTambahans = data.map(row => Number(row[6] || 0));
        const potLeasings = data.map(row => Number(row[7] || 0));
        const potATPMs = data.map(row => Number(row[8] || 0));
        const potMDs = data.map(row => Number(row[9] || 0));
        const brokers = data.map(row => Number(row[10] || 0));
        if (sheet2ChartInstance) {
          sheet2ChartInstance.destroy();
        }
        const ctx = document.getElementById("sheet2Chart").getContext("2d");
        sheet2ChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Margin Unit",
                data: marginUnits,
                backgroundColor: "rgba(255, 159, 64, 0.5)",
                borderColor: "rgba(255, 159, 64, 1)",
                borderWidth: 1,
              },
              {
                label: "Sisa Margin",
                data: sisaMargins,
                backgroundColor: "rgba(255, 99, 132, 0.5)",
                borderColor: "rgba(255, 99, 132, 1)",
                borderWidth: 1,
              },
              {
                label: "Gross Profit Setelah Sub",
                data: grossProfitSetelahSubs,
                backgroundColor: "rgba(54, 162, 235, 0.5)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1,
              },
              {
                label: "Pot Dealer",
                data: potDealers,
                backgroundColor: "rgba(75, 192, 192, 0.5)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1,
              },
              {
                label: "Pot Tambahan",
                data: potTambahans,
                backgroundColor: "rgba(153, 102, 255, 0.5)",
                borderColor: "rgba(153, 102, 255, 1)",
                borderWidth: 1,
              },
              {
                label: "Pot Leasing",
                data: potLeasings,
                backgroundColor: "rgba(255, 206, 86, 0.5)",
                borderColor: "rgba(255, 206, 86, 1)",
                borderWidth: 1,
              },
              {
                label: "Pot ATPM",
                data: potATPMs,
                backgroundColor: "rgba(199, 199, 199, 0.5)",
                borderColor: "rgba(199, 199, 199, 1)",
                borderWidth: 1,
              },
              {
                label: "Pot MD",
                data: potMDs,
                backgroundColor: "rgba(83, 102, 255, 0.5)",
                borderColor: "rgba(83, 102, 255, 1)",
                borderWidth: 1,
              },
              {
                label: "Broker",
                data: brokers,
                backgroundColor: "rgba(255, 99, 71, 0.5)",
                borderColor: "rgba(255, 99, 71, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
          },
        });
      }

      function populateSheet3Filters() {
        const mainSelectedYears = Array.from(document.querySelectorAll('#yearFilterContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        const mainSelectedCabangs = Array.from(document.querySelectorAll('#ptFilterContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        const yearContainer = document.getElementById("yearFilterSheet3");
        yearContainer.innerHTML = mainSelectedYears.length > 0 ? mainSelectedYears.join(", ") : "All";
        const cabangContainer = document.getElementById("cabangFilterSheet3");
        cabangContainer.innerHTML = mainSelectedCabangs.length > 0 ? mainSelectedCabangs.join(", ") : "All";
        const pembayaranContainer = document.getElementById("pembayaranFilterSheet3");
        pembayaranContainer.innerHTML = "";
        const dataRows = sheet3Data.slice(3);
        const pembayarans = [...new Set(dataRows.map(row => row[2]))].filter(p => p);
        pembayarans.forEach(p => {
          const label = document.createElement("label");
          label.style.marginRight = "10px";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.value = p;
          cb.className = "pembayaranCheckboxSheet3";
          cb.addEventListener("change", applySheet3Filters);
          label.appendChild(cb);
          label.appendChild(document.createTextNode(" " + p));
          pembayaranContainer.appendChild(label);
        });
      }

      function applySheet3Filters() {
        const selectedYears = Array.from(document.querySelectorAll('#yearFilterContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedCabangs = Array.from(document.querySelectorAll('#ptFilterContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedPembayarans = Array.from(document.querySelectorAll(".pembayaranCheckboxSheet3:checked")).map(cb => cb.value);
        let dataRows = sheet3Data.slice(1);
        if (selectedYears.length > 0) {
          dataRows = dataRows.filter(row => selectedYears.includes(String(row[0])));
        }
        if (selectedCabangs.length > 0) {
          dataRows = dataRows.filter(row => selectedCabangs.includes(String(row[1])));
        }
        if (selectedPembayarans.length > 0) {
          dataRows = dataRows.filter(row => selectedPembayarans.includes(String(row[2])));
        }
        renderSheet3Table(dataRows);
      }

      function renderSheet3Table(data) {
        const tbody = document.getElementById("sheet3TableBody");
        tbody.innerHTML = "";
        data.forEach(row => {
          const tr = document.createElement("tr");
          for (let i = 0; i < 16; i++) {
            const td = document.createElement("td");
            td.textContent = row[i] !== undefined ? row[i] : "-";
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        });
      }

      function renderSheet4Table(data) {
        const tbody = document.getElementById("sheet4TableBody");
        tbody.innerHTML = "";
        data.forEach(row => {
          const tr = document.createElement("tr");
          for (let i = 0; i < 15; i++) {
            const td = document.createElement("td");
            let cell = row[i];
            if (!isNaN(cell) && cell !== "") {
              td.textContent = formatNumber(cell);
            } else {
              td.textContent = cell !== undefined ? cell : "-";
            }
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        });
      }

      // Fungsi untuk mengisi filter untuk Trial Balance (Tahun, PT, GL ACC1, Bulan)
      function populateTrialBalanceFilters() {
        if (!ledgerMutationData || ledgerMutationData.length === 0) return;
        const header = ledgerMutationData[0];
        let yearIndex = -1, ptIndex = -1, monthIndex = -1, glAcc1Index = -1;
        header.forEach((col, index) => {
          const colLower = String(col).trim().toLowerCase();
          if (colLower === "tahun" || colLower === "year") {
            yearIndex = index;
          }
          if (colLower === "pt") {
            ptIndex = index;
          }
          if (colLower === "bulan" || colLower === "month") {
            monthIndex = index;
          }
          if (colLower === "gl acc1") {
            glAcc1Index = index;
          }
        });
        const yearsSet = new Set();
        const ptSet = new Set();
        const monthSet = new Set();
        const glAcc1Set = new Set();
        for (let i = 1; i < ledgerMutationData.length; i++) {
          const row = ledgerMutationData[i];
          if (yearIndex !== -1 && row[yearIndex]) {
            yearsSet.add(String(row[yearIndex]).trim());
          }
          if (ptIndex !== -1 && row[ptIndex]) {
            ptSet.add(String(row[ptIndex]).trim());
          }
          if (monthIndex !== -1 && row[monthIndex]) {
            monthSet.add(String(row[monthIndex]).trim());
          }
          if (glAcc1Index !== -1 && row[glAcc1Index]) {
            glAcc1Set.add(String(row[glAcc1Index]).trim());
          }
        }
        const yearSelect = document.getElementById("trialbalance-year-filter");
        const ptSelect = document.getElementById("trialbalance-pt-filter");
        const glAcc1Select = document.getElementById("trialbalance-gl-acc1-filter");
        const monthSelect = document.getElementById("trialbalance-month-filter");
        yearSelect.innerHTML = '<option value="">Semua</option>';
        ptSelect.innerHTML = '<option value="">Semua</option>';
        glAcc1Select.innerHTML = '<option value="">Semua</option>';
        monthSelect.innerHTML = '<option value="">Semua</option>';
        yearsSet.forEach(value => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          yearSelect.appendChild(option);
        });
        ptSet.forEach(value => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          ptSelect.appendChild(option);
        });
        glAcc1Set.forEach(value => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          glAcc1Select.appendChild(option);
        });
        monthSet.forEach(value => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          monthSelect.appendChild(option);
        });
      }

      // Fungsi untuk merender tabel Trial Balance berdasarkan filter yang dipilih
      function renderTrialBalance() {
        const container = document.getElementById("trialbalance-data-container");
        if (!ledgerMutationData || ledgerMutationData.length === 0) {
          container.innerHTML = "<p>No data available.</p>";
          return;
        }
        const selectedYear = document.getElementById("trialbalance-year-filter").value;
        const selectedPT = document.getElementById("trialbalance-pt-filter").value;
        const selectedGLAcc1 = document.getElementById("trialbalance-gl-acc1-filter").value;
        const selectedMonth = document.getElementById("trialbalance-month-filter").value;
        
        const header = ledgerMutationData[0];
        let yearIndex = -1, ptIndex = -1, monthIndex = -1, glAcc1Index = -1;
        header.forEach((col, index) => {
          const colLower = String(col).trim().toLowerCase();
          if (colLower === "tahun" || colLower === "year") {
            yearIndex = index;
          }
          if (colLower === "pt") {
            ptIndex = index;
          }
          if (colLower === "bulan" || colLower === "month") {
            monthIndex = index;
          }
          if (colLower === "gl acc1") {
            glAcc1Index = index;
          }
        });
        
        let filteredRows = [];
        for (let i = 1; i < ledgerMutationData.length; i++) {
          const row = ledgerMutationData[i];
          let include = true;
          if (selectedYear && yearIndex !== -1) {
            if (String(row[yearIndex]).trim() !== selectedYear) {
              include = false;
            }
          }
          if (selectedPT && ptIndex !== -1) {
            if (String(row[ptIndex]).trim() !== selectedPT) {
              include = false;
            }
          }
          if (selectedGLAcc1 && glAcc1Index !== -1) {
            if (String(row[glAcc1Index]).trim() !== selectedGLAcc1) {
              include = false;
            }
          }
          if (selectedMonth && monthIndex !== -1) {
            if (String(row[monthIndex]).trim() !== selectedMonth) {
              include = false;
            }
          }
          if (include) {
            filteredRows.push(row);
          }
        }
        
        let html = "<table id='trialbalance-table'><thead><tr>";
        header.forEach(cell => {
          html += `<th>${cell !== undefined ? cell : ""}</th>`;
        });
        html += "</tr></thead><tbody>";
        filteredRows.forEach(row => {
          html += "<tr>";
          row.forEach(cell => {
            html += `<td>${cell !== undefined ? cell : ""}</td>`;
          });
          html += "</tr>";
        });
        html += "</tbody></table>";
        container.innerHTML = html;
      }

      // Event listener untuk tombol filter pada Trial Balance
      document.getElementById("trialbalance-apply-filter").addEventListener("click", renderTrialBalance);

      // Fungsi untuk menangani file Income Statement
      document.getElementById("uploadIncomeStatement").addEventListener("change", handleIncomeStatementFile);
      function handleIncomeStatementFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const firstSheet = workbook.Sheets[sheetName];
          const incomeStatementData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          console.log("Data dari sheet " + sheetName + ":", incomeStatementData);
          renderIncomeStatementSheet1(incomeStatementData, sheetName);
        };
        reader.readAsArrayBuffer(file);
      }
      function renderIncomeStatementSheet1(data, sheetName) {
        const container = document.getElementById("incomeStatementSheet1");
        container.innerHTML = "";
        if (!data || data.length === 0) {
          container.innerHTML = `<p>No data found in sheet ${sheetName}.</p>`;
          return;
        }
        let html = `<h3 style="margin-top:20px; text-align:center;">Sheet: ${sheetName}</h3>`;
        html += `<table class="symmetric-table">`;
        data.forEach((row, rowIndex) => {
          html += "<tr>";
          row.forEach((cell) => {
            if (rowIndex === 0) {
              html += `<th>${cell !== undefined && cell !== null ? cell : ""}</th>`;
            } else {
              let formattedCell = cell;
              if (!isNaN(cell) && cell !== "") {
                formattedCell = formatNumber(cell);
              }
              html += `<td>${formattedCell !== undefined && formattedCell !== null ? formattedCell : ""}</td>`;
            }
          });
          html += "</tr>";
        });
        html += "</table>";
        container.innerHTML = html;
      }

      window.addEventListener("load", function () {
        const storedJsonData = localStorage.getItem("jsonData");
        const storedSheet2Data = localStorage.getItem("sheet2Data");
        const storedSheet3Data = localStorage.getItem("sheet3Data");
        const storedSheet4Data = localStorage.getItem("sheet4Data");
        const storedLedgerMutationData = localStorage.getItem("ledgerMutationData");
        if (storedJsonData && storedSheet2Data) {
          jsonData = JSON.parse(storedJsonData);
          sheet2Data = JSON.parse(storedSheet2Data);
          if (storedSheet3Data) {
            sheet3Data = JSON.parse(storedSheet3Data);
          }
          if (storedSheet4Data) {
            sheet4Data = JSON.parse(storedSheet4Data);
          }
          if (storedLedgerMutationData) {
            ledgerMutationData = JSON.parse(storedLedgerMutationData);
          }
          const rows = jsonData.slice(2);
          populateFilters(rows);
          renderTable(rows);
          updateSalesChart(rows);
          const sheet2Rows = sheet2Data.slice(1);
          renderSheet2Table(sheet2Rows);
          updateSheet2Chart(sheet2Rows);
        }
      });

      // Fungsi khusus untuk Tren Sales: Populasi filter tahun untuk grafik Bar
      function populateTrenSalesBarYearFilter() {
        const container = document.getElementById("trenSalesBarFilterContainer");
        container.innerHTML = "<strong>Pilih Tahun:</strong> ";
        let years = new Set();
        for (let i = 1; i < sheet2Data.length; i++) {
          let year = sheet2Data[i][0];
          if (year) years.add(year);
        }
        years = Array.from(years).sort();
        years.forEach(year => {
          const label = document.createElement("label");
          label.style.marginRight = "10px";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = year;
          checkbox.className = "trenSalesYearCheckbox";
          checkbox.checked = true;
          checkbox.addEventListener("change", renderTrenSalesBarChart);
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(" " + year));
          container.appendChild(label);
        });
      }
    </script>
  </body>
</html>
